<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head th:replace="~{general/fragmentos :: head}"/>
    <body>
        <header th:replace="~{general/fragmentos :: header}"/>
        
        <div class="container my-5">
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="text-center mb-4">
                        <i class="fas fa-boxes text-success"></i> 
                        Consulta Ampliada - Detalle de Productos
                    </h1>
                    <p class="text-center text-muted">
                        Análisis completo de todos los productos con información detallada y estadísticas
                    </p>
                </div>
            </div>

            <!-- Tarjetas de estadísticas generales -->
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="card bg-primary text-white shadow">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-box"></i> Total Productos
                            </h5>
                            <h2 class="mb-0" th:text="${totalProductos}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-success text-white shadow">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-check-circle"></i> Activos
                            </h5>
                            <h2 class="mb-0" th:text="${productosActivos}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-info text-white shadow">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-warehouse"></i> Disponibles
                            </h5>
                            <h2 class="mb-0" th:text="${productosDisponibles}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card bg-warning text-dark shadow">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-exclamation-triangle"></i> Stock Bajo
                            </h5>
                            <h2 class="mb-0" th:text="${productosStockBajo}">0</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card bg-secondary text-white shadow">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-times-circle"></i> Inactivos
                            </h5>
                            <h2 class="mb-0" th:text="${productosInactivos}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-danger text-white shadow">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-ban"></i> Agotados
                            </h5>
                            <h2 class="mb-0" th:text="${productosAgotados}">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-dark text-white shadow">
                        <div class="card-body text-center">
                            <h5 class="card-title">
                                <i class="fas fa-dollar-sign"></i> Valor Total Inventario
                            </h5>
                            <h2 class="mb-0" th:text="${valorTotalInventario != null ? #numbers.formatCurrency(valorTotalInventario) : '$0.00'}">$0.00</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de productos ampliada -->
            <div class="row mb-5">
                <div class="col-12">
                    <div class="card shadow-lg">
                        <div class="card-header bg-success text-white">
                            <h3 class="mb-0">
                                <i class="fas fa-table"></i> Detalle Completo de Productos
                            </h3>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>ID</th>
                                            <th>Imagen</th>
                                            <th>Descripción</th>
                                            <th>Detalle</th>
                                            <th>Categoría</th>
                                            <th class="text-end">Precio</th>
                                            <th class="text-center">Existencias</th>
                                            <th class="text-end">Valor Inventario</th>
                                            <th class="text-center">Estado Stock</th>
                                            <th class="text-center">Estado</th>
                                            <th class="text-center">Productos en Categoría</th>
                                            <th class="text-end">Precio Promedio Categoría</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:if="${#lists.isEmpty(productosAmpliados)}">
                                            <td colspan="12" class="text-center py-5 text-muted">
                                                <i class="fas fa-info-circle fa-2x mb-3"></i>
                                                <br/>No hay productos disponibles
                                            </td>
                                        </tr>
                                        <tr th:each="p : ${productosAmpliados}" 
                                            th:classappend="${p.estadoStock == 'Agotado'} ? 'table-danger' : (${p.estadoStock == 'Stock Bajo'} ? 'table-warning' : '')">
                                            <td th:text="${p.idProducto}">1</td>
                                            <td>
                                                <img th:if="${p.rutaImagen != null and p.rutaImagen != ''}" 
                                                     th:src="${p.rutaImagen}" 
                                                     class="img-thumbnail" 
                                                     style="width: 50px; height: 50px; object-fit: cover;"
                                                     th:alt="${p.descripcion}"/>
                                                <i th:unless="${p.rutaImagen != null and p.rutaImagen != ''}" 
                                                   class="fas fa-image text-muted"></i>
                                            </td>
                                            <td>
                                                <strong th:text="${p.descripcion}">Producto</strong>
                                            </td>
                                            <td>
                                                <small class="text-muted" th:text="${p.detalle != null ? (#strings.abbreviate(p.detalle, 50)) : 'Sin detalle'}">Detalle</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info" th:text="${p.nombreCategoria}">Categoría</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="text-success fw-bold" 
                                                      th:text="${#numbers.formatCurrency(p.precio)}">$0.00</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge" 
                                                      th:classappend="${p.existencias == 0} ? 'bg-danger' : (${p.existencias < 10} ? 'bg-warning text-dark' : 'bg-success')"
                                                      th:text="${p.existencias}">0</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="text-primary fw-bold"
                                                      th:text="${p.valorTotalInventario != null ? #numbers.formatCurrency(p.valorTotalInventario) : '$0.00'}">
                                                    $0.00
                                                </span>
                                            </td>
                                            <td class="text-center">
                                                <span th:if="${p.estadoStock == 'Disponible'}" 
                                                      class="badge bg-success" th:text="${p.estadoStock}">Disponible</span>
                                                <span th:if="${p.estadoStock == 'Stock Bajo'}" 
                                                      class="badge bg-warning text-dark" th:text="${p.estadoStock}">Stock Bajo</span>
                                                <span th:if="${p.estadoStock == 'Agotado'}" 
                                                      class="badge bg-danger" th:text="${p.estadoStock}">Agotado</span>
                                            </td>
                                            <td class="text-center">
                                                <span th:if="${p.activo}" 
                                                      class="badge bg-success">Activo</span>
                                                <span th:unless="${p.activo}" 
                                                      class="badge bg-secondary">Inactivo</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-secondary" th:text="${p.productosEnCategoria}">0</span>
                                            </td>
                                            <td class="text-end">
                                                <span class="text-muted" 
                                                      th:text="${p.precioPromedioCategoria != null ? #numbers.formatCurrency(p.precioPromedioCategoria) : 'N/A'}">
                                                    $0.00
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td colspan="5"><strong>Totales</strong></td>
                                            <td colspan="1"></td>
                                            <td class="text-center">
                                                <strong th:text="${#aggregates.sum(productosAmpliados.![existencias])}">0</strong>
                                            </td>
                                            <td class="text-end">
                                                <strong th:text="${valorTotalInventario != null ? #numbers.formatCurrency(valorTotalInventario) : '$0.00'}">$0.00</strong>
                                            </td>
                                            <td colspan="4"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información adicional -->
            <div class="row">
                <div class="col-12">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-info-circle text-success"></i> Información de la Consulta
                            </h5>
                            <p class="card-text">
                                Esta consulta ampliada muestra información detallada de todos los productos del inventario. 
                                Incluye:
                            </p>
                            <ul>
                                <li><strong>Información del Producto:</strong> ID, descripción, detalle e imagen</li>
                                <li><strong>Categoría:</strong> Categoría a la que pertenece cada producto</li>
                                <li><strong>Precio y Existencias:</strong> Precio unitario y cantidad disponible</li>
                                <li><strong>Valor del Inventario:</strong> Valor total del producto (precio × existencias)</li>
                                <li><strong>Estado del Stock:</strong> Disponible, Stock Bajo (< 10 unidades) o Agotado</li>
                                <li><strong>Estado del Producto:</strong> Activo o Inactivo</li>
                                <li><strong>Estadísticas de Categoría:</strong> Cantidad de productos en la misma categoría y precio promedio</li>
                            </ul>
                            <div class="mt-3">
                                <a th:href="@{/}" class="btn btn-primary">
                                    <i class="fas fa-home"></i> Volver al Inicio
                                </a>
                                <a th:href="@{/producto/listado}" class="btn btn-secondary">
                                    <i class="fas fa-list"></i> Ver Listado de Productos
                                </a>
                                <a th:href="@{/consultas/listado}" class="btn btn-info">
                                    <i class="fas fa-search"></i> Ver Otras Consultas
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <footer th:replace="~{general/fragmentos :: footer}"/>
        <section th:replace="~{general/fragmentos :: mostrarToast}"/>
    </body>
</html>

